branches: master

pipeline:
  prepare-workdir:
    image: owncloudci/php
    pull: true
    commands:
      - git clone https://github.com/scality/cloudserver.git scality-s3server
      - cd ./scality-s3server
      - git checkout 7.4.4.10
  override-entrypoint-script:
    image: owncloud/ubuntu
    pull: true
    commands:
      - cp -f docker-entrypoint.sh scality-s3server/docker-entrypoint.sh

  dryrun:
    image: plugins/docker:17.12
    pull: true
    dockerfile: ./scality-s3server/Dockerfile
    context: scality-s3server
    secrets: [ docker_username, docker_password ]
    repo: owncloudci/scality-s3server
    label_schema:
      - version=7.4
    tags: [ 'latest', '7.4' ]
    when:
      event: [ pull_request ]
    dry_run: true

  docker:
    image: plugins/docker:17.12
    pull: true
    dockerfile: ./scality-s3server/Dockerfile
    context: scality-s3server
    secrets: [ docker_username, docker_password ]
    repo: owncloudci/scality-s3server
    label_schema:
      - version=7.4
    tags: [ 'latest', '7.4' ]
    when:
      event: [ push ]
